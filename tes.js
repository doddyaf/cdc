var express=require("express");var session=require("express-session");var bodyParser=require("body-parser");var cookieParser=require("cookie-parser");var app=express();var router=express.Router();var http=require("http").Server(app);var io=require("socket.io")(http);var path=require("path");app.use(express.static(__dirname+"/public"));app.use(cookieParser());app.use(session({secret:"doddyagung",resave:true,saveUninitialized:true}));app.use(bodyParser.json());app.use(bodyParser.urlencoded({extended:true}));app.set("title","Career Development Center - ITI");var config={homeUrl:"http://localhost:3000",db:{host:"localhost",user:"root",password:"",name:"cdc"}};var mysql=require("mysql");var connection=mysql.createConnection({host:config.db.host,user:config.db.user,password:config.db.password,database:config.db.name});connection.connect();var cdc={};cdc.insertPost=function(e){var t=connection.query("INSERT INTO post SET ?",e,function(e,t){if(e)throw e})};cdc.getAllPosts=function(e){var t="";var n="SELECT post.*, user.first_name, user.last_name, post_category.name AS category_name FROM post, user, post_category WHERE user.id = user_id AND post_category.id = post_category_id ORDER BY post.id DESC";connection.query(n,function(n,r,i){if(n)throw n;t={posts:r};jsonAllPosts=JSON.stringify(t);e(null,jsonAllPosts)})};var User={};User.authenticate=function(e,t,n,r){var i="SELECT * FROM user WHERE email='"+n+"' AND password = MD5('"+r+"');";connection.query(i,function(n,r,i){if(n)throw n;console.log(r.length);if(r.length==1){e.session.user_id=r[0].id}t.redirect("/")})};User.register=function(e,t,n,r){var i="INSERT ;";connection.query(i,function(n,r,i){if(n)throw n;console.log(r.length);if(r.length==1){e.session.user_id=r[0].id}t.redirect("/")})};router.use(function(e,t,n){console.log(e.method,e.url);if(e.url!="/login"){if(e.url=="/register"||e.session.user_id){return n()}t.redirect("/login")}else if(e.url=="/login"){if(e.session.user_id){t.redirect("/")}else{return n()}}});router.get("/api/cdc/",function(e,t){var n=function(e,n){t.send(n)};var r=cdc.getAllPosts(n)});router.post("/api/ts",function(e,t){var n=e.body.alamat;t.send(n)});router.get("/",function(e,t){t.sendFile(path.join(__dirname,"/view","index.html"))});router.get("/cdc",function(e,t){t.sendFile(path.join(__dirname,"/view","cdc.html"))});router.get("/ts-form",function(e,t){t.sendFile(path.join(__dirname,"/view","ts-form.html"))});router.get("/ts-statistik",function(e,t){t.sendFile(path.join(__dirname,"/view","ts-statistik.html"))});router.get("/gallery",function(e,t){t.sendFile(path.join(__dirname,"/view","gallery.html"))});router.get("/profile",function(e,t){t.sendFile(path.join(__dirname,"/view","profile.html"))});router.get("/faq",function(e,t){t.sendFile(path.join(__dirname,"/view","faq.html"))});router.get("/login",function(e,t){t.sendFile(path.join(__dirname,"/view","login.html"))});router.post("/login",function(e,t){console.log(e.body.user_email+e.body.user_password);var n=e.body.user_email,r=e.body.user_password;User.authenticate(e,t,n,r)});router.get("/register",function(e,t){t.sendFile(path.join(__dirname,"/view","register.html"))});router.post("/register",function(e,t){console.log(e.body.user_email+e.body.user_password);var n=e.body.user_email,r=e.body.user_password;User.register(e,t,n,r)});router.get("/logout",function(e,t){e.session.user_id=null;t.redirect("/login")});app.use("/",router);io.on("connection",function(e){e.on("chat message",function(e){io.emit("chat message",e)})});io.on("connection",function(e){e.on("cdc post",function(e){io.emit("cdc post",e);cdc.insertPost(e)})});http.listen(3e3,function(){console.log("listening on *:3000")})